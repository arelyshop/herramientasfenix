<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fenix Editor Pro - M√°scaras y Orden Corregido</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap');
        
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: #0f172a;
            color: #f8fafc;
            overflow: hidden; 
        }

        .editor-container {
            display: grid;
            grid-template-columns: 280px 1fr 300px;
            height: 100vh;
        }

        .canvas-area {
            background-image: radial-gradient(#334155 1px, transparent 1px);
            background-size: 20px 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            padding: 2rem;
            overflow: hidden; 
        }

        #canvas-wrapper {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%; 
            width: 100%;
        }

        canvas {
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            background-color: white;
            cursor: default;
            max-height: 85vh; 
            max-width: 100%;  
            height: auto;
            width: auto;
            aspect-ratio: 1 / 1; 
            object-fit: contain;
        }

        .layer-item.active {
            background-color: #1e293b;
            border-left: 4px solid #38bdf8;
        }

        /* Indicador de Pincel */
        #brush-cursor {
            position: fixed;
            border: 2px solid rgba(56, 189, 248, 0.9);
            border-radius: 50%;
            pointer-events: none;
            display: none;
            z-index: 9999;
            background: rgba(56, 189, 248, 0.1);
            transform: translate(-50%, -50%);
        }

        /* Gu√≠a de Selecci√≥n Rectangular */
        #selection-guide {
            position: absolute;
            border: 1px solid #38bdf8;
            background: rgba(56, 189, 248, 0.2);
            pointer-events: none;
            display: none;
            z-index: 999;
        }

        .layer-item.dragging { opacity: 0.3; background-color: #334155; }
        .layer-item.drag-over { border-top: 2px solid #38bdf8; }

        .mask-active-canvas {
            outline: 3px solid #ef4444 !important;
            outline-offset: 4px;
        }

        /* Estilo para bot√≥n de herramienta activa */
        .tool-active {
            background-color: #38bdf8 !important;
            color: #0f172a !important;
            border-color: #38bdf8 !important;
        }

        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
    </style>
</head>
<body>

    <div id="brush-cursor"></div>

    <div class="editor-container">
        <!-- Barra Lateral Izquierda -->
        <aside class="bg-slate-900 border-r border-slate-800 p-4 flex flex-col gap-6 overflow-y-auto">
            <div class="flex items-center gap-3 px-2">
                <div class="w-8 h-8 bg-sky-500 rounded-lg flex items-center justify-center font-bold text-slate-900">F</div>
                <h1 class="text-lg font-bold tracking-tight">Fenix Pro</h1>
            </div>

            <div class="space-y-3">
                <p class="text-[10px] font-bold text-slate-500 uppercase px-2 mb-1 tracking-widest">Recursos / Marcas</p>
                <div class="grid grid-cols-1 gap-2 px-1">
                    <button onclick="addBrand('ugreen')" class="brand-btn w-full flex items-center gap-3 p-2 bg-slate-800/30 border border-slate-700 rounded-lg transition-all text-left hover:border-sky-500">
                        <div class="w-6 h-6 bg-slate-700 rounded flex items-center justify-center text-[8px] font-bold text-sky-400">UG</div>
                        <span class="text-xs font-semibold">Ugreen</span>
                    </button>
                    <button onclick="addBrand('anker')" class="brand-btn w-full flex items-center gap-3 p-2 bg-slate-800/30 border border-slate-700 rounded-lg transition-all text-left hover:border-sky-500">
                        <div class="w-6 h-6 bg-slate-700 rounded flex items-center justify-center text-[8px] font-bold text-sky-400">AN</div>
                        <span class="text-xs font-semibold">Anker</span>
                    </button>
                    <button onclick="addBrand('dimax')" class="brand-btn w-full flex items-center gap-3 p-2 bg-slate-800/30 border border-slate-700 rounded-lg transition-all text-left hover:border-sky-500">
                        <div class="w-6 h-6 bg-slate-700 rounded flex items-center justify-center text-[8px] font-bold text-sky-400">DX</div>
                        <span class="text-xs font-semibold">Dimax</span>
                    </button>
                    <button onclick="addBrand('baseus')" class="brand-btn w-full flex items-center gap-3 p-2 bg-slate-800/30 border border-slate-700 rounded-lg transition-all text-left hover:border-sky-500">
                        <div class="w-6 h-6 bg-slate-700 rounded flex items-center justify-center text-[8px] font-bold text-sky-400">BS</div>
                        <span class="text-xs font-semibold">Baseus</span>
                    </button>
                    <button onclick="addBrand('havit')" class="brand-btn w-full flex items-center gap-3 p-2 bg-slate-800/30 border border-slate-700 rounded-lg transition-all text-left hover:border-sky-500">
                        <div class="w-6 h-6 bg-slate-700 rounded flex items-center justify-center text-[8px] font-bold text-sky-400">HV</div>
                        <span class="text-xs font-semibold">Havit</span>
                    </button>
                </div>
            </div>

            <div id="mask-help-box" class="hidden space-y-3 bg-red-500/10 border border-red-500/20 p-3 rounded-xl">
                <p class="text-[10px] font-bold text-red-400 uppercase tracking-tighter">Editando M√°scara</p>
                <p class="text-[11px] text-slate-300 leading-tight">Haz clic y arrastra sobre la imagen para recortar.</p>
                <button onclick="exitMaskMode()" class="w-full py-2 bg-red-500 hover:bg-red-600 text-white text-[10px] font-bold rounded-lg transition-all">TERMINAR EDICI√ìN</button>
            </div>

            <div class="mt-auto pt-4 space-y-4">
                <label class="block group cursor-pointer">
                    <div class="bg-sky-500 hover:bg-sky-400 text-slate-900 font-bold py-3 rounded-xl text-center text-sm transition-all shadow-lg shadow-sky-500/20">
                        A√±adir Imagen
                    </div>
                    <input type="file" id="fileInput" class="hidden" accept="image/*">
                </label>
                <button onclick="exportImage()" class="w-full border border-slate-700 hover:bg-slate-800 py-3 rounded-xl text-sm font-medium transition-all text-slate-300">
                    Exportar PNG
                </button>
            </div>
        </aside>

        <!-- √Årea Central -->
        <main class="canvas-area relative">
            <div id="canvas-wrapper">
                <canvas id="mainCanvas" width="1000" height="1000"></canvas>
                <div id="selection-guide"></div>
            </div>
        </main>

        <!-- Barra Lateral Derecha -->
        <aside class="bg-slate-900 border-l border-slate-800 flex flex-col">
            <div class="p-6 border-b border-slate-800">
                <p class="text-[10px] font-bold text-slate-500 uppercase mb-4 tracking-widest">Propiedades</p>
                
                <div id="no-layer-msg" class="text-slate-500 text-xs italic text-center py-4">Selecciona una capa</div>
                
                <div id="layer-props" class="hidden space-y-6">
                    <!-- Herramientas de M√°scara -->
                    <div class="space-y-3">
                        <p class="text-[10px] font-bold text-slate-400 uppercase">M√°scara de Recorte</p>
                        <div class="grid grid-cols-2 gap-2">
                            <button onclick="enterMaskMode('brush')" id="btn-mask-brush" class="bg-slate-800 hover:bg-slate-700 p-2 rounded-lg text-[10px] font-bold border border-slate-700 transition-all">Pincel</button>
                            <button onclick="enterMaskMode('rect')" id="btn-mask-rect" class="bg-slate-800 hover:bg-slate-700 p-2 rounded-lg text-[10px] font-bold border border-slate-700 transition-all">Rect√°ngulo</button>
                        </div>
                        <div id="mask-controls-panel" class="hidden space-y-3 pt-2 bg-slate-800/50 p-2 rounded-lg">
                            <div class="flex items-center justify-between">
                                <span class="text-[10px] text-slate-400">ACCI√ìN:</span>
                                <div class="flex gap-1">
                                    <button onclick="setMaskAction('reveal')" id="m-action-reveal" class="px-2 py-1 bg-slate-700 text-white text-[9px] font-bold rounded">Mostrar</button>
                                    <button onclick="setMaskAction('hide')" id="m-action-hide" class="px-2 py-1 bg-sky-500 text-slate-900 text-[9px] font-bold rounded">Ocultar</button>
                                </div>
                            </div>
                            <div>
                                <label class="flex justify-between text-[10px] text-slate-400 mb-1">Pincel <span id="val-brush-size">50px</span></label>
                                <input type="range" id="input-brush-size" min="5" max="300" value="50" class="w-full accent-sky-500">
                            </div>
                            <button onclick="resetMask()" class="w-full py-1 text-[9px] text-red-400 font-bold uppercase hover:bg-red-500/10 rounded">Borrar M√°scara</button>
                        </div>
                    </div>

                    <div class="h-px bg-slate-800"></div>

                    <button onclick="fitActiveLayerToCanvas()" class="w-full bg-slate-800 hover:bg-slate-700 border border-slate-700 py-2 rounded-lg text-xs font-bold transition-all">
                        Ajustar al Lienzo
                    </button>

                    <div>
                        <label class="flex justify-between text-xs text-slate-400 mb-2">Opacidad <span id="opacity-val">100%</span></label>
                        <input type="range" id="prop-opacity" min="0" max="100" value="100" class="w-full accent-sky-500">
                    </div>
                    
                    <div>
                        <label class="block text-xs text-slate-400 mb-2">Modo de Fusi√≥n</label>
                        <select id="prop-blend" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-2.5 text-xs outline-none focus:ring-1 focus:ring-sky-500 text-white">
                            <option value="source-over">Normal</option>
                            <option value="multiply">Multiplicar</option>
                            <option value="screen">Trama</option>
                            <option value="overlay">Superponer</option>
                            <option value="darken">Oscurecer</option>
                            <option value="lighten">Aclarar</option>
                        </select>
                    </div>

                    <button onclick="deleteActiveLayer()" class="w-full bg-red-500/10 text-red-500 hover:bg-red-500 hover:text-white p-2.5 rounded-lg text-xs font-bold transition-all">Eliminar Capa</button>
                </div>
            </div>

            <!-- Lista de Capas -->
            <div class="flex-1 p-6 overflow-y-auto">
                <p class="text-[10px] font-bold text-slate-500 uppercase mb-4 tracking-widest">Capas</p>
                <div id="layer-list" class="space-y-2"></div>
            </div>
        </aside>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-8 left-1/2 -translate-x-1/2 bg-slate-800 border border-slate-700 px-6 py-3 rounded-full text-sm font-medium shadow-2xl transition-all opacity-0 pointer-events-none z-50">
        Mensaje
    </div>

    <script>
        const canvas = document.getElementById('mainCanvas');
        const ctx = canvas.getContext('2d');
        const layerListEl = document.getElementById('layer-list');
        const fileInput = document.getElementById('fileInput');
        const selectionGuide = document.getElementById('selection-guide');
        const brushCursor = document.getElementById('brush-cursor');
        
        const maskBuffer = document.createElement('canvas');
        const mbfCtx = maskBuffer.getContext('2d');

        const CANVAS_WIDTH = 1000;
        const CANVAS_HEIGHT = 1000;

        let layers = [];
        let activeLayerId = null;
        let isMouseDown = false;
        let dragOffset = { x: 0, y: 0 };
        let shiftPressed = false;
        let draggedItemIdx = null;

        let maskMode = false; 
        let maskAction = 'hide'; 
        let maskBrushSize = 50;
        let maskStartX, maskStartY;
        let maskWorldStartX, maskWorldStartY; 

        function init() {
            render();
            setupEventListeners();
        }

        window.addEventListener('keydown', (e) => { if(e.key === 'Shift') shiftPressed = true; });
        window.addEventListener('keyup', (e) => { if(e.key === 'Shift') shiftPressed = false; });

        function createId() { return Math.random().toString(36).substr(2, 9); }

        function addLayer(data, name = "Capa", brandKey = null) {
            const layer = {
                id: createId(),
                name: name,
                visible: true,
                opacity: 100,
                blend: 'source-over',
                x: 0, y: 0, width: 0, height: 0, rotation: 0, aspectRatio: 1, 
                content: null,
                maskCanvas: null 
            };

            const img = new Image();
            img.onload = () => {
                layer.aspectRatio = img.width / img.height;
                layer.width = img.width;
                layer.height = img.height;
                layer.content = img;

                const mCanvas = document.createElement('canvas');
                mCanvas.width = img.width;
                mCanvas.height = img.height;
                const mCtx = mCanvas.getContext('2d');
                mCtx.fillStyle = 'white';
                mCtx.fillRect(0, 0, mCanvas.width, mCanvas.height);
                layer.maskCanvas = mCanvas;

                if (brandKey) {
                    switch (brandKey) {
                        case 'ugreen': layer.x = (CANVAS_WIDTH - layer.width) / 2; layer.y = 0; break;
                        case 'anker': layer.x = 55; layer.y = 0; break;
                        case 'dimax': layer.x = 0; layer.y = CANVAS_HEIGHT - layer.height - 85; break;
                        case 'baseus': layer.x = 45; layer.y = 0; break;
                        case 'havit': layer.x = 0; layer.y = CANVAS_HEIGHT - layer.height - 95; break;
                    }
                } else {
                    const ratio = Math.min(CANVAS_WIDTH * 0.7 / img.width, CANVAS_HEIGHT * 0.7 / img.height);
                    layer.width = img.width * ratio;
                    layer.height = img.height * ratio;
                    layer.x = (CANVAS_WIDTH - layer.width) / 2;
                    layer.y = (CANVAS_HEIGHT - layer.height) / 2;
                }

                layers.unshift(layer);
                setActiveLayer(layer.id);
                render();
            };
            img.src = data;
        }

        function addBrand(brand) {
            const path = `images/marcas/logo-${brand}.png`;
            addLayer(path, `${brand.toUpperCase()}`, brand);
        }

        function setActiveLayer(id) {
            if (maskMode) return; 
            activeLayerId = id;
            updateUI();
            render();
        }

        // --- SISTEMA DE M√ÅSCARA ---

        function enterMaskMode(mode) {
            if (!activeLayerId) return;
            maskMode = mode;
            document.getElementById('mask-controls-panel').classList.remove('hidden');
            document.getElementById('mask-help-box').classList.remove('hidden');
            canvas.classList.add('mask-active-canvas');
            
            // Actualizar botones de herramienta
            document.getElementById('btn-mask-brush').classList.remove('tool-active');
            document.getElementById('btn-mask-rect').classList.remove('tool-active');
            if (mode === 'brush') {
                document.getElementById('btn-mask-brush').classList.add('tool-active');
                brushCursor.style.display = 'block';
                updateBrushCursorVisual();
            } else if (mode === 'rect') {
                document.getElementById('btn-mask-rect').classList.add('tool-active');
                brushCursor.style.display = 'none';
            }
            updateUI();
        }

        function exitMaskMode() {
            maskMode = false;
            document.getElementById('mask-controls-panel').classList.add('hidden');
            document.getElementById('mask-help-box').classList.add('hidden');
            canvas.classList.remove('mask-active-canvas');
            
            // Limpiar estilos de botones
            document.getElementById('btn-mask-brush').classList.remove('tool-active');
            document.getElementById('btn-mask-rect').classList.remove('tool-active');
            
            brushCursor.style.display = 'none';
            selectionGuide.style.display = 'none';
            render();
        }

        function updateBrushCursorVisual() {
            const rect = canvas.getBoundingClientRect();
            const visualSize = maskBrushSize * (rect.width / CANVAS_WIDTH);
            brushCursor.style.width = visualSize + 'px';
            brushCursor.style.height = visualSize + 'px';
        }

        function setMaskAction(action) {
            maskAction = action;
            document.getElementById('m-action-reveal').className = action === 'reveal' ? 'px-2 py-1 bg-sky-500 text-slate-900 text-[9px] font-bold rounded transition-all' : 'px-2 py-1 bg-slate-700 text-white text-[9px] font-bold rounded transition-all';
            document.getElementById('m-action-hide').className = action === 'hide' ? 'px-2 py-1 bg-sky-500 text-slate-900 text-[9px] font-bold rounded transition-all' : 'px-2 py-1 bg-slate-700 text-white text-[9px] font-bold rounded transition-all';
        }

        function resetMask() {
            const layer = layers.find(l => l.id === activeLayerId);
            if (layer && layer.maskCanvas) {
                const mCtx = layer.maskCanvas.getContext('2d');
                mCtx.fillStyle = 'white';
                mCtx.fillRect(0, 0, layer.maskCanvas.width, layer.maskCanvas.height);
                render();
                showToast("M√°scara restaurada");
            }
        }

        function paintOnMask(localX, localY, isFirst) {
            const layer = layers.find(l => l.id === activeLayerId);
            if (!layer) return;
            const mCtx = layer.maskCanvas.getContext('2d');
            const imgX = (localX / layer.width) * layer.maskCanvas.width;
            const imgY = (localY / layer.height) * layer.maskCanvas.height;
            const realBrushSize = (maskBrushSize / layer.width) * layer.maskCanvas.width;
            mCtx.save();
            mCtx.lineCap = 'round'; mCtx.lineJoin = 'round';
            mCtx.lineWidth = realBrushSize;
            mCtx.globalCompositeOperation = maskAction === 'reveal' ? 'source-over' : 'destination-out';
            mCtx.strokeStyle = 'white';
            if (isFirst) { mCtx.beginPath(); mCtx.arc(imgX, imgY, realBrushSize/2, 0, Math.PI * 2); mCtx.fill(); }
            else { mCtx.beginPath(); mCtx.moveTo(maskStartX, maskStartY); mCtx.lineTo(imgX, imgY); mCtx.stroke(); }
            mCtx.restore();
            maskStartX = imgX; maskStartY = imgY;
        }

        function applyRectMask(x1, y1, x2, y2) {
            const layer = layers.find(l => l.id === activeLayerId);
            if (!layer) return;
            const mCtx = layer.maskCanvas.getContext('2d');
            const imgX1 = (x1 / layer.width) * layer.maskCanvas.width;
            const imgY1 = (y1 / layer.height) * layer.maskCanvas.height;
            const imgX2 = (x2 / layer.width) * layer.maskCanvas.width;
            const imgY2 = (y2 / layer.height) * layer.maskCanvas.height;
            mCtx.save();
            mCtx.globalCompositeOperation = maskAction === 'reveal' ? 'source-over' : 'destination-out';
            mCtx.fillStyle = 'white';
            mCtx.fillRect(imgX1, imgY1, imgX2 - imgX1, imgY2 - imgY1);
            mCtx.restore();
            render();
        }

        function render() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            [...layers].reverse().forEach(l => {
                if (!l.visible) return;
                ctx.save();
                const centerX = l.x + l.width / 2;
                const centerY = l.y + l.height / 2;
                ctx.translate(centerX, centerY);
                ctx.rotate(l.rotation);
                ctx.globalAlpha = l.opacity / 100;
                ctx.globalCompositeOperation = l.blend;
                maskBuffer.width = l.width; maskBuffer.height = l.height;
                mbfCtx.clearRect(0, 0, l.width, l.height);
                mbfCtx.drawImage(l.content, 0, 0, l.width, l.height);
                mbfCtx.globalCompositeOperation = 'destination-in';
                mbfCtx.drawImage(l.maskCanvas, 0, 0, l.width, l.height);
                ctx.drawImage(maskBuffer, -l.width / 2, -l.height / 2);
                if (l.id === activeLayerId && !maskMode) {
                    ctx.strokeStyle = '#38bdf8'; ctx.lineWidth = 2;
                    ctx.strokeRect(-l.width / 2, -l.height / 2, l.width, l.height);
                    ctx.fillStyle = '#38bdf8'; ctx.fillRect(l.width / 2 - 8, l.height / 2 - 8, 16, 16);
                    ctx.beginPath(); ctx.moveTo(0, -l.height / 2); ctx.lineTo(0, -l.height / 2 - 30); ctx.stroke();
                    ctx.beginPath(); ctx.arc(0, -l.height / 2 - 35, 10, 0, Math.PI * 2); ctx.fill();
                }
                ctx.restore();
            });

            if (activeLayerId && shiftPressed && isMouseDown && !maskMode) {
                const layer = layers.find(l => l.id === activeLayerId);
                ctx.setLineDash([5, 5]); ctx.lineWidth = 1; ctx.strokeStyle = 'rgba(56, 189, 248, 0.7)';
                const lX = layer.x, lCX = layer.x + layer.width/2, lR = layer.x + layer.width;
                const lY = layer.y, lCY = layer.y + layer.height/2, lB = layer.y + layer.height;
                if (Math.abs(lX) < 1) { ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(0,1000); ctx.stroke(); }
                if (Math.abs(lCX-500) < 1) { ctx.beginPath(); ctx.moveTo(500,0); ctx.lineTo(500,1000); ctx.stroke(); }
                if (Math.abs(lR-1000) < 1) { ctx.beginPath(); ctx.moveTo(1000,0); ctx.lineTo(1000,1000); ctx.stroke(); }
                if (Math.abs(lY) < 1) { ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(1000,0); ctx.stroke(); }
                if (Math.abs(lCY-500) < 1) { ctx.beginPath(); ctx.moveTo(0,500); ctx.lineTo(1000,500); ctx.stroke(); }
                if (Math.abs(lB-1000) < 1) { ctx.beginPath(); ctx.moveTo(0,1000); ctx.lineTo(1000,1000); ctx.stroke(); }
                ctx.setLineDash([]);
            }
        }

        function setupEventListeners() {
            canvas.addEventListener('mousedown', e => {
                const pos = getMousePos(e);
                const activeLayer = layers.find(l => l.id === activeLayerId);
                if (!activeLayer) return;
                const centerX = activeLayer.x + activeLayer.width / 2;
                const centerY = activeLayer.y + activeLayer.height / 2;
                const dx = pos.x - centerX, dy = pos.y - centerY;
                const localX = dx * Math.cos(-activeLayer.rotation) - dy * Math.sin(-activeLayer.rotation);
                const localY = dx * Math.sin(-activeLayer.rotation) + dy * Math.cos(-activeLayer.rotation);

                if (maskMode) {
                    isMouseDown = true;
                    maskStartX = (localX + activeLayer.width / 2);
                    maskStartY = (localY + activeLayer.height / 2);
                    if (maskMode === 'brush') paintOnMask(maskStartX, maskStartY, true);
                    else if (maskMode === 'rect') {
                        maskWorldStartX = pos.x; maskWorldStartY = pos.y;
                        selectionGuide.style.display = 'block';
                        updateSelectionGuide(pos.x, pos.y, pos.x, pos.y);
                    }
                    return;
                }

                if (Math.sqrt(Math.pow(localX - 0, 2) + Math.pow(localY - (-activeLayer.height/2 - 35), 2)) < 20) { activeLayer.isRotating = true; }
                else if (Math.abs(localX - activeLayer.width/2) < 20 && Math.abs(localY - activeLayer.height/2) < 20) { activeLayer.isResizing = true; }
                else if (Math.abs(localX) < activeLayer.width/2 && Math.abs(localY) < activeLayer.height/2) {
                    activeLayer.isDragging = true; dragOffset.x = pos.x - activeLayer.x; dragOffset.y = pos.y - activeLayer.y;
                }
                if (activeLayer.isRotating || activeLayer.isResizing || activeLayer.isDragging) isMouseDown = true;
            });

            window.addEventListener('mousemove', e => {
                const pos = getMousePos(e);
                const activeLayer = layers.find(l => l.id === activeLayerId);
                if (maskMode === 'brush') { brushCursor.style.left = e.clientX + 'px'; brushCursor.style.top = e.clientY + 'px'; }
                if (!isMouseDown || !activeLayer) return;
                if (maskMode) {
                    const centerX = activeLayer.x + activeLayer.width / 2;
                    const centerY = activeLayer.y + activeLayer.height / 2;
                    const dx = pos.x - centerX, dy = pos.y - centerY;
                    const localX = dx * Math.cos(-activeLayer.rotation) - dy * Math.sin(-activeLayer.rotation) + activeLayer.width/2;
                    const localY = dx * Math.sin(-activeLayer.rotation) + dy * Math.cos(-activeLayer.rotation) + activeLayer.height/2;
                    if (maskMode === 'brush') { paintOnMask(localX, localY, false); render(); }
                    else if (maskMode === 'rect') { updateSelectionGuide(maskWorldStartX, maskWorldStartY, pos.x, pos.y); }
                    return;
                }
                if (activeLayer.isRotating) {
                    const centerX = activeLayer.x + activeLayer.width / 2;
                    const centerY = activeLayer.y + activeLayer.height / 2;
                    let angle = Math.atan2(pos.y - centerY, pos.x - centerX) + Math.PI / 2;
                    if (shiftPressed) { angle = (Math.round((angle * 180 / Math.PI) / 45) * 45) * Math.PI / 180; }
                    activeLayer.rotation = angle;
                } else if (activeLayer.isResizing) {
                    const centerX = activeLayer.x + activeLayer.width / 2;
                    const centerY = activeLayer.y + activeLayer.height / 2;
                    const dx = pos.x - centerX, dy = pos.y - centerY;
                    const localX = dx * Math.cos(-activeLayer.rotation) - dy * Math.sin(-activeLayer.rotation);
                    let newWidth = Math.max(20, localX * 2);
                    activeLayer.width = newWidth; activeLayer.height = newWidth / activeLayer.aspectRatio;
                    activeLayer.x = centerX - activeLayer.width / 2; activeLayer.y = centerY - activeLayer.height / 2;
                } else if (activeLayer.isDragging) {
                    let newX = pos.x - dragOffset.x, newY = pos.y - dragOffset.y;
                    if (shiftPressed) {
                        const t = 35;
                        if (Math.abs(newX) < t) newX = 0;
                        else if (Math.abs(newX + activeLayer.width/2 - 500) < t) newX = 500 - activeLayer.width/2;
                        else if (Math.abs(newX + activeLayer.width - 1000) < t) newX = 1000 - activeLayer.width;
                        if (Math.abs(newY) < t) newY = 0;
                        else if (Math.abs(newY + activeLayer.height/2 - 500) < t) newY = 500 - activeLayer.height/2;
                        else if (Math.abs(newY + activeLayer.height - 1000) < t) newY = 1000 - activeLayer.height;
                    }
                    activeLayer.x = newX; activeLayer.y = newY;
                }
                render();
            });

            window.addEventListener('mouseup', e => {
                if (maskMode === 'rect' && isMouseDown) {
                    const pos = getMousePos(e);
                    const activeLayer = layers.find(l => l.id === activeLayerId);
                    const centerX = activeLayer.x + activeLayer.width / 2;
                    const centerY = activeLayer.y + activeLayer.height / 2;
                    const startDx = maskWorldStartX - centerX, startDy = maskWorldStartY - centerY;
                    const startLocalX = startDx * Math.cos(-activeLayer.rotation) - startDy * Math.sin(-activeLayer.rotation) + activeLayer.width/2;
                    const startLocalY = startDx * Math.sin(-activeLayer.rotation) + startDy * Math.cos(-activeLayer.rotation) + activeLayer.height/2;
                    const endDx = pos.x - centerX, endDy = pos.y - centerY;
                    const endLocalX = endDx * Math.cos(-activeLayer.rotation) - endDy * Math.sin(-activeLayer.rotation) + activeLayer.width/2;
                    const endLocalY = endDx * Math.sin(-activeLayer.rotation) + endDy * Math.cos(-activeLayer.rotation) + activeLayer.height/2;
                    applyRectMask(startLocalX, startLocalY, endLocalX, endLocalY);
                }
                isMouseDown = false; selectionGuide.style.display = 'none';
                layers.forEach(l => { l.isDragging = l.isResizing = l.isRotating = false; });
                render();
            });

            document.getElementById('input-brush-size').oninput = (e) => {
                maskBrushSize = e.target.value; document.getElementById('val-brush-size').textContent = e.target.value + 'px';
                if(maskMode === 'brush') updateBrushCursorVisual();
            };
            document.getElementById('prop-opacity').oninput = (e) => {
                const layer = layers.find(l => l.id === activeLayerId);
                if (layer) { layer.opacity = e.target.value; document.getElementById('opacity-val').textContent = e.target.value + '%'; render(); }
            };
            document.getElementById('prop-blend').onchange = (e) => {
                const layer = layers.find(l => l.id === activeLayerId);
                if (layer) { layer.blend = e.target.value; render(); }
            };
            fileInput.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (ev) => addLayer(ev.target.result, file.name);
                    reader.readAsDataURL(file);
                    fileInput.value = "";
                }
            };
        }

        function updateSelectionGuide(x1, y1, x2, y2) {
            const rect = canvas.getBoundingClientRect();
            const scale = rect.width / CANVAS_WIDTH;
            const left = (Math.min(x1, x2) * scale) + canvas.offsetLeft;
            const top = (Math.min(y1, y2) * scale) + canvas.offsetTop;
            const width = Math.abs(x1 - x2) * scale;
            const height = Math.abs(y1 - y2) * scale;
            selectionGuide.style.left = left + 'px'; selectionGuide.style.top = top + 'px';
            selectionGuide.style.width = width + 'px'; selectionGuide.style.height = height + 'px';
        }

        function updateUI() {
            layerListEl.innerHTML = '';
            layers.forEach((l, index) => {
                const div = document.createElement('div');
                div.className = `layer-item flex items-center gap-3 p-3 rounded-xl cursor-pointer transition-all hover:bg-slate-800/30 ${activeLayerId === l.id ? 'active' : ''}`;
                div.draggable = true;
                div.ondragstart = (e) => { draggedItemIdx = index; div.classList.add('dragging'); };
                div.ondragover = (e) => { e.preventDefault(); div.classList.add('drag-over'); };
                div.ondragleave = () => div.classList.remove('drag-over');
                div.ondrop = (e) => {
                    e.preventDefault(); div.classList.remove('drag-over');
                    const movedItem = layers.splice(draggedItemIdx, 1)[0];
                    layers.splice(index, 0, movedItem); render(); updateUI();
                };
                div.ondragend = () => div.classList.remove('dragging');
                div.onclick = () => setActiveLayer(l.id);
                div.innerHTML = `
                    <div class="cursor-grab active:cursor-grabbing text-slate-500 hover:text-sky-400 py-1 px-1">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M7 7h2v2H7V7zm0 4h2v2H7v-2zm4-4h2v2h-2V7zm0 4h2v2h-2v-2zM7 3h2v2H7V3zm4 0h2v2h-2V3z"/></svg>
                    </div>
                    <div class="w-10 h-10 bg-slate-800 rounded overflow-hidden border border-slate-700 flex-shrink-0">
                        <img src="${l.content.src}" class="w-full h-full object-contain ${l.visible ? 'opacity-80' : 'opacity-20 grayscale'}">
                    </div>
                    <span class="text-[11px] font-medium flex-1 truncate ${!l.visible ? 'text-slate-600 italic' : ''}">${l.name}</span>
                    <button onclick="event.stopPropagation(); toggleVisibility('${l.id}')" class="p-2 text-slate-500 hover:text-white transition-colors">
                        ${l.visible ? 'üëÅÔ∏è' : 'üï∂Ô∏è'}
                    </button>
                `;
                layerListEl.appendChild(div);
            });
            const propsEl = document.getElementById('layer-props');
            const noLayerEl = document.getElementById('no-layer-msg');
            const activeLayer = layers.find(l => l.id === activeLayerId);
            if (activeLayer) {
                propsEl.classList.remove('hidden'); noLayerEl.classList.add('hidden');
                document.getElementById('opacity-val').textContent = activeLayer.opacity + '%';
                document.getElementById('prop-opacity').value = activeLayer.opacity;
                document.getElementById('prop-blend').value = activeLayer.blend;
            } else { propsEl.classList.add('hidden'); noLayerEl.classList.remove('hidden'); }
        }

        function getMousePos(e) {
            const rect = canvas.getBoundingClientRect();
            return { x: (e.clientX - rect.left) * (CANVAS_WIDTH / rect.width), y: (e.clientY - rect.top) * (CANVAS_HEIGHT / rect.height) };
        }

        function fitActiveLayerToCanvas() {
            const layer = layers.find(l => l.id === activeLayerId);
            if (layer) {
                if (layer.aspectRatio > 1) { layer.height = 1000; layer.width = 1000 * layer.aspectRatio; }
                else { layer.width = 1000; layer.height = 1000 / layer.aspectRatio; }
                layer.x = (1000 - layer.width)/2; layer.y = (1000 - layer.height)/2; layer.rotation = 0; render();
            }
        }

        function toggleVisibility(id) {
            const layer = layers.find(l => l.id === id);
            if (layer) { layer.visible = !layer.visible; render(); updateUI(); }
        }

        function deleteActiveLayer() {
            layers = layers.filter(l => l.id !== activeLayerId); activeLayerId = layers.length > 0 ? layers[0].id : null; render(); updateUI();
        }

        function showToast(msg) {
            const toast = document.getElementById('toast'); toast.textContent = msg; toast.classList.add('opacity-100');
            setTimeout(() => toast.classList.remove('opacity-100'), 2000);
        }

        function exportImage() {
            const oldId = activeLayerId; activeLayerId = null; render();
            setTimeout(() => {
                const link = document.createElement('a'); link.download = 'fenix-master-' + Date.now() + '.png';
                link.href = canvas.toDataURL('image/png'); link.click();
                setActiveLayer(oldId);
            }, 100);
        }

        init();
    </script>
</body>
</html>
