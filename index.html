<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arelyshop Pro - Editor de Fotos</title>
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="images/favicon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap');
        
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: #0f172a;
            color: #f8fafc;
            height: 100vh;
            overflow: hidden; 
        }

        .editor-container {
            display: grid;
            grid-template-columns: 280px 1fr 300px;
            height: 100vh;
            width: 100vw;
        }

        .canvas-area {
            background-image: radial-gradient(#334155 1px, transparent 1px);
            background-size: 20px 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            padding: 2rem;
            overflow: hidden; 
        }

        /* Efecto visual al arrastrar archivo sobre el canvas */
        .canvas-area.drag-active {
            background-color: rgba(244, 63, 94, 0.1);
            outline: 4px dashed #f43f5e;
            outline-offset: -20px;
        }

        #canvas-wrapper {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%; 
            width: 100%;
        }

        canvas {
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            background-color: white;
            cursor: default;
            max-height: 85vh; 
            max-width: 100%;  
            height: auto;
            width: auto;
            aspect-ratio: 1 / 1; 
            object-fit: contain;
        }

        .layer-item.active {
            background-color: #334155 !important;
            border-left: 4px solid #f43f5e;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .layer-item.active .thumb-container {
            border-color: #f43f5e;
        }

        #brush-cursor {
            position: fixed;
            border: 2px solid rgba(244, 63, 94, 0.8);
            border-radius: 50%;
            pointer-events: none;
            display: none;
            z-index: 9999;
            background: rgba(244, 63, 94, 0.1);
            transform: translate(-50%, -50%);
        }

        #selection-guide {
            position: absolute;
            border: 1px solid #f43f5e;
            background: rgba(244, 63, 94, 0.2);
            pointer-events: none;
            display: none;
            z-index: 999;
        }

        .layer-item.dragging { opacity: 0.3; background-color: #334155; }
        .layer-item.drag-over { border-top: 2px solid #f43f5e; }

        .mask-active-canvas { outline: 3px solid #ef4444 !important; outline-offset: 4px; }
        .tool-active { background-color: #f43f5e !important; color: #ffffff !important; border-color: #f43f5e !important; }

        #textModal { background-color: rgba(0, 0, 0, 0.7); backdrop-filter: blur(4px); z-index: 10000; }

        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 10px; }
        
        input[type=range] { accent-color: #f43f5e; }

        .sidebar-scrollable {
            overflow-y: auto;
            max-height: 100vh;
        }
    </style>
</head>
<body>

    <div id="brush-cursor"></div>

    <div id="textModal" class="fixed inset-0 flex items-center justify-center hidden">
        <div class="bg-slate-900 p-6 rounded-2xl shadow-2xl w-80 border border-slate-700">
            <h3 class="text-xs font-bold text-slate-400 mb-4 uppercase tracking-widest text-center">Ingresa la medida</h3>
            <input type="text" id="modalInput" placeholder="Ej: 50 cm" class="w-full px-4 py-3 bg-slate-800 border border-slate-700 rounded-xl text-white text-lg text-center focus:outline-none focus:ring-2 focus:ring-rose-500 mb-4">
            <div class="flex space-x-2">
                <button id="cancelText" class="flex-1 px-4 py-2 bg-slate-800 text-slate-400 rounded-xl font-bold text-sm hover:bg-slate-700 transition-all">Cancelar</button>
                <button id="saveText" class="flex-1 px-4 py-2 bg-rose-500 text-white rounded-xl font-bold text-sm hover:bg-rose-600 transition-all">Guardar</button>
            </div>
        </div>
    </div>

    <div class="editor-container">
        <!-- Barra Lateral Izquierda -->
        <aside class="bg-slate-900 border-r border-slate-800 p-4 flex flex-col gap-6 sidebar-scrollable">
            <div class="flex items-center gap-3 px-2">
                <!-- Logo con imagen favicon.png -->
                <div id="logo-container" class="w-8 h-8 rounded-lg overflow-hidden shadow-lg shadow-rose-500/20 bg-slate-800 flex items-center justify-center">
                    <img src="images/favicon.png" alt="Logo" class="w-full h-full object-contain" onerror="handleLogoError(this)">
                </div>
                <h1 class="text-lg font-bold tracking-tight text-slate-100">Arelyshop Pro</h1>
            </div>

            <!-- Herramientas -->
            <div class="space-y-3">
                <p class="text-[10px] font-bold text-slate-500 uppercase px-2 mb-1 tracking-widest">Herramientas</p>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="setEditorMode('move')" id="btn-mode-move" class="tool-active flex flex-col items-center justify-center p-2 border border-slate-700 rounded-xl transition-all">
                        <svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px" fill="currentColor" class="mb-1"><path d="M200-200h57l391-391-57-57-391 391v57Zm-80 80v-170l528-527q12-11 26.5-17t30.5-6q16 0 31 6t26 18l55 56q12 11 17.5 26t5.5 30q0 16-5.5 30.5T817-647L290-120H120Zm640-584-56-56 56 56Zm-141 85-28-29 57 57-29-28Z"/></svg>
                        <span class="text-[9px] font-bold uppercase">Editor</span>
                    </button>
                    <button onclick="setEditorMode('measure')" id="btn-mode-measure" class="flex flex-col items-center justify-center p-2 border border-slate-700 rounded-xl transition-all bg-slate-800/50">
                        <svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px" fill="currentColor" class="mb-1"><path d="M680-280q-72 0-127-45.5T484-440H272q-12 27-37 43.5T180-380q-42 0-71-29t-29-71q0-42 29-71t71-29q30 0 55 16.5t37 43.5h212q14-69 69-114.5T680-680q83 0 141.5 58.5T880-480q0 83-58.5 141.5T680-280Zm85-115q35-35 35-85t-35-85q-35-35-85-35t-85 35q-35 35-35 85t35 85q35 35 85 35t85-35Z"/></svg>
                        <span class="text-[9px] font-bold uppercase">Medida</span>
                    </button>
                    <button onclick="setEditorMode('styles')" id="btn-mode-styles" class="col-span-2 flex flex-row items-center justify-center gap-3 p-3 border border-slate-700 rounded-xl transition-all bg-slate-800/50">
                        <svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px" fill="currentColor"><path d="M480-80q-82 0-155-31.5t-127.5-86Q143-252 111.5-325T80-480q0-83 32.5-156t88-127Q256-817 330-848.5T488-880q80 0 151 27.5t124.5 76q53.5 48.5 85 115T880-518q0 115-70 176.5T640-280h-74q-9 0-12.5 5t-3.5 11q0 12 15 34.5t15 51.5q0 50-27.5 74T480-80Zm0-400Zm-177 23q17-17 17-43t-17-43q-17-17-43-17t-43 17q-17 17-17 43t17 43q17 17 43 17t43-17Zm120-160q17-17 17-43t-17-43q-17-17-43-17t-43 17q-17 17-17 43t17 43q17 17 43 17t43-17Zm200 0q17-17 17-43t-17-43q-17-17-43-17t-43 17q-17 17-17 43t17 43q17 17 43 17t43-17Zm120 160q17-17 17-43t-17-43q-17-17-43-17t-43 17q-17 17-17 43t17 43q17 17 43 17t43-17ZM480-160q9 0 14.5-5t5.5-13q0-14-15-33t-15-57q0-42 29-67t71-25h70q66 0 113-38.5T800-518q0-121-92.5-201.5T480-720q-113 0-207.5 59.5T128-500q50 101 144.5 160.5T480-280q113 0 207.5-59.5Z"/></svg>
                        <span class="text-[9px] font-bold uppercase">Estilos (Color)</span>
                    </button>
                </div>
            </div>

            <!-- Marcas -->
            <div class="space-y-3">
                <p class="text-[10px] font-bold text-slate-500 uppercase px-2 mb-1 tracking-widest">Recursos / Marcas</p>
                <div class="grid grid-cols-1 gap-2 px-1">
                    <button onclick="addBrand('ugreen')" class="brand-btn w-full flex items-center gap-3 p-2 bg-slate-800/30 border border-slate-700 rounded-lg transition-all text-left hover:border-rose-500">
                        <div class="w-6 h-6 bg-slate-700 rounded flex items-center justify-center text-[8px] font-bold text-rose-400">UG</div>
                        <span class="text-xs font-semibold">Ugreen</span>
                    </button>
                    <button onclick="addBrand('anker')" class="brand-btn w-full flex items-center gap-3 p-2 bg-slate-800/30 border border-slate-700 rounded-lg transition-all text-left hover:border-rose-500">
                        <div class="w-6 h-6 bg-slate-700 rounded flex items-center justify-center text-[8px] font-bold text-rose-400">AN</div>
                        <span class="text-xs font-semibold">Anker</span>
                    </button>
                    <button onclick="addBrand('dimax')" class="brand-btn w-full flex items-center gap-3 p-2 bg-slate-800/30 border border-slate-700 rounded-lg transition-all text-left hover:border-rose-500">
                        <div class="w-6 h-6 bg-slate-700 rounded flex items-center justify-center text-[8px] font-bold text-rose-400">DX</div>
                        <span class="text-xs font-semibold">Dimax</span>
                    </button>
                    <button onclick="addBrand('baseus')" class="brand-btn w-full flex items-center gap-3 p-2 bg-slate-800/30 border border-slate-700 rounded-lg transition-all text-left hover:border-rose-500">
                        <div class="w-6 h-6 bg-slate-700 rounded flex items-center justify-center text-[8px] font-bold text-rose-400">BS</div>
                        <span class="text-xs font-semibold">Baseus</span>
                    </button>
                    <button onclick="addBrand('havit')" class="brand-btn w-full flex items-center gap-3 p-2 bg-slate-800/30 border border-slate-700 rounded-lg transition-all text-left hover:border-rose-500">
                        <div class="w-6 h-6 bg-slate-700 rounded flex items-center justify-center text-[8px] font-bold text-rose-400">HV</div>
                        <span class="text-xs font-semibold">Havit</span>
                    </button>
                </div>
            </div>

            <div id="mask-help-box" class="hidden space-y-3 bg-red-500/10 border border-red-500/20 p-3 rounded-xl">
                <p class="text-[10px] font-bold text-red-400 uppercase tracking-tighter">Editando Máscara</p>
                <button onclick="exitMaskMode()" class="w-full py-2 bg-red-500 hover:bg-red-600 text-white text-[10px] font-bold rounded-lg transition-all uppercase">Terminar</button>
            </div>

            <div class="mt-auto pt-4 space-y-4">
                <label class="block group cursor-pointer">
                    <div class="bg-rose-500 hover:bg-rose-400 text-white font-bold py-3 rounded-xl text-center text-sm transition-all shadow-lg shadow-rose-500/20">
                        Añadir Imagen
                    </div>
                    <input type="file" id="fileInput" class="hidden" accept="image/*" multiple>
                </label>
                
                <div class="space-y-2 border-t border-slate-800 pt-4 pb-4">
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="exportImage('png')" class="flex flex-col items-center justify-center p-2 bg-slate-800 hover:bg-slate-700 border border-slate-700 rounded-xl transition-all">
                            <span class="text-[10px] font-bold text-rose-400">PNG</span>
                            <span class="text-[8px] text-slate-500 uppercase tracking-tighter">Transp.</span>
                        </button>
                        <button onclick="exportImage('jpeg')" class="flex flex-col items-center justify-center p-2 bg-slate-800 hover:bg-slate-700 border border-slate-700 rounded-xl transition-all">
                            <span class="text-[10px] font-bold text-emerald-400">JPG</span>
                            <span class="text-[8px] text-slate-500 uppercase tracking-tighter">Blanco</span>
                        </button>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Área Central -->
        <main id="canvas-dropzone" class="canvas-area relative">
            <div id="canvas-wrapper">
                <canvas id="mainCanvas" width="1000" height="1000"></canvas>
                <div id="selection-guide"></div>
            </div>
        </main>

        <!-- Barra Lateral Derecha -->
        <aside class="bg-slate-900 border-l border-slate-800 flex flex-col sidebar-scrollable">
            <div class="p-6 flex flex-col gap-6">
                <div>
                    <p class="text-[10px] font-bold text-slate-500 uppercase mb-4 tracking-widest">Propiedades</p>
                    
                    <div id="measure-props" class="hidden space-y-4">
                        <p class="text-[10px] font-bold text-rose-400 uppercase italic">Ajustes de Medida</p>
                        <p class="text-[11px] text-slate-400 leading-tight">Usa SHIFT para trazos rectos. Haz clic en la 'X' para borrar o mover la medida.</p>
                        <button onclick="clearAllMeasures()" class="w-full bg-red-500/10 text-red-500 border border-red-500/20 py-2 rounded-lg text-xs font-bold hover:bg-red-500 hover:text-white transition-all uppercase">Borrar medidas</button>
                    </div>

                    <div id="styles-props" class="hidden space-y-6">
                        <div class="space-y-4">
                            <div class="flex justify-between items-center">
                                <p class="text-[10px] font-bold text-rose-400 uppercase italic">HUE / Color</p>
                                <button onclick="resetColorStyles()" class="text-[8px] font-bold text-slate-500 hover:text-rose-400 uppercase tracking-widest">Restablecer</button>
                            </div>
                            <div class="space-y-4 bg-slate-800/40 p-3 rounded-xl border border-slate-700/50">
                                <div>
                                    <label class="flex justify-between text-[10px] text-slate-400 mb-1 uppercase">Tono (Hue) <span id="val-hue">0°</span></label>
                                    <input type="range" id="input-hue" min="-180" max="180" value="0" class="w-full h-1.5 bg-slate-700 rounded-lg appearance-none cursor-pointer">
                                </div>
                                <div>
                                    <label class="flex justify-between text-[10px] text-slate-400 mb-1 uppercase">Saturación <span id="val-sat">100%</span></label>
                                    <input type="range" id="input-sat" min="0" max="200" value="100" class="w-full h-1.5 bg-slate-700 rounded-lg appearance-none cursor-pointer">
                                </div>
                            </div>
                        </div>
                        <div class="h-px bg-slate-800"></div>
                        <div class="space-y-4">
                            <p class="text-[10px] font-bold text-rose-400 uppercase italic">Niveles</p>
                            <div class="space-y-3 bg-slate-800/40 p-3 rounded-xl border border-slate-700/50">
                                <div>
                                    <label class="flex justify-between text-[10px] text-slate-400 mb-1 uppercase">Negros <span id="val-lv-black">0</span></label>
                                    <input type="range" id="input-lv-black" min="0" max="250" value="0" class="w-full h-1.5 bg-slate-700 rounded-lg appearance-none cursor-pointer">
                                </div>
                                <div>
                                    <label class="flex justify-between text-[10px] text-slate-400 mb-1 uppercase">Medios <span id="val-lv-mid">1.0</span></label>
                                    <input type="range" id="input-lv-mid" min="0.1" max="3" step="0.1" value="1" class="w-full h-1.5 bg-slate-700 rounded-lg appearance-none cursor-pointer">
                                </div>
                                <div>
                                    <label class="flex justify-between text-[10px] text-slate-400 mb-1 uppercase">Blancos <span id="val-lv-white">255</span></label>
                                    <input type="range" id="input-lv-white" min="5" max="255" value="255" class="w-full h-1.5 bg-slate-700 rounded-lg appearance-none cursor-pointer">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="no-layer-msg" class="text-slate-500 text-xs italic text-center py-4">Selecciona una capa</div>
                    
                    <div id="layer-props" class="hidden space-y-6">
                        <div id="editor-specific-props">
                            <div class="space-y-3">
                                <p class="text-[10px] font-bold text-slate-400 uppercase">Máscara de Recorte</p>
                                <div class="grid grid-cols-2 gap-2">
                                    <button onclick="enterMaskMode('brush')" id="btn-mask-brush" class="bg-slate-800 hover:bg-slate-700 p-2 rounded-lg text-[10px] font-bold border border-slate-700 transition-all">Pincel</button>
                                    <button onclick="enterMaskMode('rect')" id="btn-mask-rect" class="bg-slate-800 hover:bg-slate-700 p-2 rounded-lg text-[10px] font-bold border border-slate-700 transition-all">Rectángulo</button>
                                </div>
                                <div id="mask-controls-panel" class="hidden space-y-3 pt-2 bg-slate-800/50 p-2 rounded-lg">
                                    <div class="flex items-center justify-between">
                                        <span class="text-[10px] text-slate-400 uppercase text-[9px]">ACCIÓN:</span>
                                        <div class="flex gap-1">
                                            <button onclick="setMaskAction('reveal')" id="m-action-reveal" class="px-2 py-1 bg-slate-700 text-white text-[9px] font-bold rounded">Mostrar</button>
                                            <button onclick="setMaskAction('hide')" id="m-action-hide" class="px-2 py-1 bg-rose-500 text-white text-[9px] font-bold rounded">Ocultar</button>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="flex justify-between text-[10px] text-slate-400 mb-1">Pincel <span id="val-brush-size">50px</span></label>
                                        <input type="range" id="input-brush-size" min="5" max="300" value="50" class="w-full accent-rose-500">
                                    </div>
                                    <button onclick="resetMask()" class="w-full py-1 text-[9px] text-red-400 hover:text-red-300 font-bold uppercase transition-all">Reiniciar Máscara</button>
                                </div>
                            </div>
                            <div class="h-px bg-slate-800 my-6"></div>
                            <div class="space-y-4">
                                <div class="flex justify-between items-center">
                                    <p class="text-[10px] font-bold text-slate-400 uppercase">Transformación</p>
                                    <button onclick="resetTransform()" class="text-[8px] font-bold text-slate-500 hover:text-rose-400 uppercase tracking-widest">Restablecer</button>
                                </div>
                                <div>
                                    <label class="flex justify-between text-xs text-slate-400 mb-2 italic"><span>Escala</span><span id="scale-val">100%</span></label>
                                    <input type="range" id="prop-scale" min="5" max="200" value="100" class="w-full accent-rose-400 h-1.5 bg-slate-700 rounded-lg appearance-none cursor-pointer">
                                </div>
                                <button onclick="fitActiveLayerToCanvas()" class="w-full bg-slate-800 hover:bg-slate-700 border border-slate-700 py-2 rounded-lg text-[10px] font-bold transition-all uppercase">Ajustar Lienzo</button>
                            </div>
                            <div class="h-px bg-slate-800 my-6"></div>
                            <div class="space-y-4">
                                <p class="text-[10px] font-bold text-slate-400 uppercase">Apariencia</p>
                                <div>
                                    <label class="flex justify-between text-xs text-slate-400 mb-2">Opacidad <span id="opacity-val">100%</span></label>
                                    <input type="range" id="prop-opacity" min="0" max="100" value="100" class="w-full accent-rose-500 h-1.5 bg-slate-700 rounded-lg appearance-none cursor-pointer">
                                </div>
                                <div>
                                    <label class="block text-xs text-slate-400 mb-2">Fusión</label>
                                    <select id="prop-blend" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-2 text-xs outline-none focus:ring-1 focus:ring-rose-500 text-white">
                                        <option value="source-over">Normal</option>
                                        <option value="multiply">Multiplicar</option>
                                        <option value="screen">Trama</option>
                                        <option value="overlay">Superponer</option>
                                        <option value="darken">Oscurecer</option>
                                        <option value="lighten">Aclarar</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <button onclick="deleteActiveLayer()" class="w-full bg-red-500/10 text-red-500 hover:bg-red-500 hover:text-white p-2.5 rounded-lg text-xs font-bold transition-all uppercase tracking-tighter">Eliminar Capa</button>
                    </div>
                </div>

                <div>
                    <p class="text-[10px] font-bold text-slate-500 uppercase mb-4 tracking-widest">Capas</p>
                    <div id="layer-list" class="space-y-2 pb-10"></div>
                </div>
            </div>
        </aside>
    </div>

    <div id="toast" class="fixed bottom-8 left-1/2 -translate-x-1/2 bg-slate-800 border border-slate-700 px-6 py-3 rounded-full text-sm font-medium shadow-2xl transition-all opacity-0 pointer-events-none z-50">Mensaje</div>

    <script>
        /**
         * Manejador de error para el logo (favicon.png)
         */
        function handleLogoError(img) {
            const parent = img.parentElement || document.getElementById('logo-container');
            if (parent) {
                img.style.display = 'none';
                parent.innerText = 'A';
                parent.classList.add('bg-rose-500', 'font-bold', 'text-white');
            }
        }

        const canvas = document.getElementById('mainCanvas');
        const ctx = canvas.getContext('2d');
        const layerListEl = document.getElementById('layer-list');
        const fileInput = document.getElementById('fileInput');
        const selectionGuide = document.getElementById('selection-guide');
        const brushCursor = document.getElementById('brush-cursor');
        const dropZone = document.getElementById('canvas-dropzone');
        
        const maskBuffer = document.createElement('canvas');
        const mbfCtx = maskBuffer.getContext('2d');

        const CANVAS_WIDTH = 1000;
        const CANVAS_HEIGHT = 1000;

        let layers = [];
        let activeLayerId = null;
        let editorMode = 'move'; 
        let isMouseDown = false;
        let dragOffset = { x: 0, y: 0 };
        let shiftPressed = false;
        let draggedItemIdx = null;
        let layerClipboard = null; 

        let maskMode = false; 
        let maskAction = 'hide'; 
        let maskBrushSize = 50;
        let maskStartX, maskStartY;
        let maskWorldStartX, maskWorldStartY; 

        let measures = [];
        let activeMeasure = null;
        let pendingMeasure = null;
        let draggingMeasureIdx = -1;
        let hoveredMeasureIdx = -1; 
        let mDragOffset = { x: 0, y: 0 };
        let hasMovedDraggedMeasure = false;

        const MODAL = {
            el: document.getElementById('textModal'),
            input: document.getElementById('modalInput'),
            save: document.getElementById('saveText'),
            cancel: document.getElementById('cancelText')
        };

        function init() { 
            render(); 
            setupEventListeners();
            setupKeyboardShortcuts();
            setupDragAndDrop();
        }

        function createId() { return Math.random().toString(36).substr(2, 9); }

        function setupDragAndDrop() {
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(evt => {
                dropZone.addEventListener(evt, e => { e.preventDefault(); e.stopPropagation(); }, false);
            });
            dropZone.addEventListener('dragenter', () => dropZone.classList.add('drag-active'), false);
            dropZone.addEventListener('dragover', () => dropZone.classList.add('drag-active'), false);
            dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-active'), false);
            dropZone.addEventListener('drop', (e) => {
                dropZone.classList.remove('drag-active');
                const files = Array.from(e.dataTransfer.files);
                const imageFiles = files.filter(f => f.type.startsWith('image/'));
                
                if (imageFiles.length > 0) {
                    showToast(`Cargando ${imageFiles.length} imágenes...`);
                    imageFiles.forEach(file => {
                        const reader = new FileReader();
                        reader.onload = (ev) => addLayer(ev.target.result, file.name);
                        reader.readAsDataURL(file);
                    });
                }
            }, false);
        }

        function setupKeyboardShortcuts() {
            window.addEventListener('keydown', (e) => {
                if (e.key === 'Shift') shiftPressed = true;
                if (!MODAL.el.classList.contains('hidden')) return;
                if ((e.ctrlKey || e.metaKey) && e.key === 'c') {
                    const active = layers.find(l => l.id === activeLayerId);
                    if (active) {
                        layerClipboard = JSON.parse(JSON.stringify(active));
                        layerClipboard.content = active.content;
                        showToast("Capa copiada");
                    }
                }
                if ((e.ctrlKey || e.metaKey) && e.key === 'v') {
                    if (layerClipboard) pasteLayer();
                }
                if (e.key === 'Delete' || e.key === 'Backspace') {
                    if (activeLayerId && editorMode === 'move' && !maskMode) deleteActiveLayer();
                }
            });
            window.addEventListener('keyup', (e) => { if(e.key === 'Shift') shiftPressed = false; });
        }

        function pasteLayer() {
            const newLayer = JSON.parse(JSON.stringify(layerClipboard));
            newLayer.id = createId();
            newLayer.x += 30; newLayer.y += 30;
            newLayer.content = layerClipboard.content;
            newLayer.processedCanvas = document.createElement('canvas');
            newLayer.processedCanvas.width = newLayer.content.width;
            newLayer.processedCanvas.height = newLayer.content.height;
            newLayer.maskCanvas = document.createElement('canvas');
            newLayer.maskCanvas.width = newLayer.content.width;
            newLayer.maskCanvas.height = newLayer.content.height;
            const originalLayer = layers.find(l => l.id === activeLayerId);
            if (originalLayer) {
                newLayer.maskCanvas.getContext('2d').drawImage(originalLayer.maskCanvas, 0, 0);
            } else {
                const mCtx = newLayer.maskCanvas.getContext('2d');
                mCtx.fillStyle = 'white'; mCtx.fillRect(0,0,newLayer.maskCanvas.width, newLayer.maskCanvas.height);
            }
            applyEffects(newLayer);
            layers.unshift(newLayer);
            setActiveLayer(newLayer.id);
            showToast("Capa pegada");
        }

        function addLayer(data, name = "Capa", brandKey = null) {
            const layer = {
                id: createId(),
                name: name,
                visible: true,
                opacity: 100,
                blend: 'source-over',
                x: 0, y: 0, width: 0, height: 0, rotation: 0, aspectRatio: 1, 
                content: null,
                maskCanvas: null,
                levels: { black: 0, gamma: 1.0, white: 255 },
                hsl: { hue: 0, saturation: 1.0 },
                processedCanvas: document.createElement('canvas')
            };

            const img = new Image();
            img.onload = () => {
                layer.aspectRatio = img.width / img.height;
                layer.width = img.width;
                layer.height = img.height;
                layer.content = img;
                layer.processedCanvas.width = img.width;
                layer.processedCanvas.height = img.height;
                const mCanvas = document.createElement('canvas');
                mCanvas.width = img.width; mCanvas.height = img.height;
                const mCtx = mCanvas.getContext('2d');
                mCtx.fillStyle = 'white'; mCtx.fillRect(0, 0, mCanvas.width, mCanvas.height);
                layer.maskCanvas = mCanvas;

                if (brandKey) {
                    switch (brandKey) {
                        case 'ugreen': layer.x = (CANVAS_WIDTH-layer.width)/2; layer.y = 0; break;
                        case 'anker': layer.x = 55; layer.y = 0; break;
                        case 'dimax': layer.x = 0; layer.y = CANVAS_HEIGHT-layer.height-85; break;
                        case 'baseus': layer.x = 45; layer.y = 0; break;
                        case 'havit': layer.x = 0; layer.y = CANVAS_HEIGHT-layer.height-95; break;
                    }
                } else {
                    const ratio = Math.min(CANVAS_WIDTH*0.7/img.width, CANVAS_HEIGHT*0.7/img.height);
                    layer.width = img.width*ratio; layer.height = img.height*ratio;
                    
                    // Desfase aleatorio pequeño para que las capas múltiples no se tapen exactamente
                    const offset = layers.length * 20;
                    layer.x = (CANVAS_WIDTH-layer.width)/2 + (offset % 100); 
                    layer.y = (CANVAS_HEIGHT-layer.height)/2 + (offset % 100);
                }
                applyEffects(layer);
                layers.unshift(layer);
                setActiveLayer(layer.id);
                render();
            };
            img.src = data;
        }

        function applyEffects(layer) {
            if (!layer.content) return;
            const pCtx = layer.processedCanvas.getContext('2d');
            pCtx.drawImage(layer.content, 0, 0);
            const imageData = pCtx.getImageData(0, 0, layer.processedCanvas.width, layer.processedCanvas.height);
            const data = imageData.data;
            const { black, gamma, white } = layer.levels;
            const { hue, saturation } = layer.hsl;
            const range = white - black;
            const lut = new Uint8ClampedArray(256);
            for (let i = 0; i < 256; i++) {
                let v = (i - black) / range;
                v = Math.max(0, Math.min(1, v));
                v = Math.pow(v, 1 / gamma);
                lut[i] = v * 255;
            }
            for (let i = 0; i < data.length; i += 4) {
                let r = lut[data[i]], g = lut[data[i+1]], b = lut[data[i+2]];
                if (hue !== 0 || saturation !== 1.0) {
                    const gray = 0.299 * r + 0.587 * g + 0.114 * b;
                    r = gray + saturation * (r - gray); g = gray + saturation * (g - gray); b = gray + saturation * (b - gray);
                    if (hue !== 0) {
                        const a = hue * Math.PI / 180, u = Math.cos(a), w = Math.sin(a);
                        const nr = (.299+.701*u+.168*w)*r + (.587-.587*u+.330*w)*g + (.114-.114*u-.497*w)*b;
                        const ng = (.299-.299*u-.328*w)*r + (.587+.413*u+.035*w)*g + (.114-.114*u-.292*w)*b;
                        const nb = (.299-.3*u-1.25*w)*r + (.587-.588*u-1.05*w)*g + (.114+.886*u-.203*w)*b;
                        r = nr; g = ng; b = nb;
                    }
                }
                data[i] = r; data[i+1] = g; data[i+2] = b;
            }
            pCtx.putImageData(imageData, 0, 0);
        }

        /**
         * Funciones de Restablecimiento
         */
        function resetColorStyles() {
            const l = layers.find(l => l.id === activeLayerId);
            if (!l) return;
            l.hsl = { hue: 0, saturation: 1.0 };
            l.levels = { black: 0, gamma: 1.0, white: 255 };
            applyEffects(l);
            updateUI();
            render();
            showToast("Ajustes de color restablecidos");
        }

        function resetTransform() {
            const l = layers.find(l => l.id === activeLayerId);
            if (!l) return;
            l.rotation = 0;
            l.opacity = 100;
            l.blend = 'source-over';
            // Volver al tamaño del 100% (1000px de ancho por defecto)
            const cx = l.x + l.width / 2, cy = l.y + l.height / 2;
            l.width = 1000; l.height = 1000 / l.aspectRatio;
            l.x = cx - l.width/2; l.y = cy - l.height/2;
            updateUI();
            render();
            showToast("Transformación restablecida");
        }

        function addBrand(brand) {
            const path = `images/marcas/logo-${brand}.png`;
            addLayer(path, `${brand.toUpperCase()}`, brand);
        }

        function setActiveLayer(id) {
            if (maskMode) return; 
            activeLayerId = id;
            updateUI();
            render();
        }

        function setEditorMode(mode) {
            editorMode = mode;
            document.getElementById('btn-mode-move').className = mode === 'move' ? 'tool-active flex flex-col items-center justify-center p-2 border border-slate-700 rounded-xl transition-all' : 'flex flex-col items-center justify-center p-2 border border-slate-700 rounded-xl transition-all bg-slate-800/50';
            document.getElementById('btn-mode-measure').className = mode === 'measure' ? 'tool-active flex flex-col items-center justify-center p-2 border border-slate-700 rounded-xl transition-all' : 'flex flex-col items-center justify-center p-2 border border-slate-700 rounded-xl transition-all bg-slate-800/50';
            document.getElementById('btn-mode-styles').className = mode === 'styles' ? 'tool-active flex flex-row items-center justify-center gap-3 p-3 border border-slate-700 rounded-xl transition-all' : 'flex flex-row items-center justify-center gap-3 p-3 border border-slate-700 rounded-xl transition-all bg-slate-800/50';
            document.getElementById('measure-props').classList.toggle('hidden', mode !== 'measure');
            document.getElementById('styles-props').classList.toggle('hidden', mode !== 'styles');
            document.getElementById('editor-specific-props').classList.toggle('hidden', mode !== 'move');
            if (mode === 'measure') { activeLayerId = null; exitMaskMode(); }
            if (mode === 'styles') exitMaskMode();
            updateUI();
            render();
        }

        function enterMaskMode(mode) {
            if (!activeLayerId) return;
            maskMode = mode;
            document.getElementById('mask-controls-panel').classList.remove('hidden');
            document.getElementById('mask-help-box').classList.remove('hidden');
            canvas.classList.add('mask-active-canvas');
            document.getElementById('btn-mask-brush').classList.toggle('tool-active', mode === 'brush');
            document.getElementById('btn-mask-rect').classList.toggle('tool-active', mode === 'rect');
            if (mode === 'brush') { brushCursor.style.display = 'block'; updateBrushCursorVisual(); }
            else { brushCursor.style.display = 'none'; }
            updateUI();
        }

        function exitMaskMode() {
            maskMode = false;
            document.getElementById('mask-controls-panel').classList.add('hidden');
            document.getElementById('mask-help-box').classList.add('hidden');
            canvas.classList.remove('mask-active-canvas');
            document.getElementById('btn-mask-brush').classList.remove('tool-active');
            document.getElementById('btn-mask-rect').classList.remove('tool-active');
            brushCursor.style.display = 'none'; selectionGuide.style.display = 'none';
            render();
        }

        function updateBrushCursorVisual() {
            const rect = canvas.getBoundingClientRect();
            const visualSize = maskBrushSize * (rect.width / CANVAS_WIDTH);
            brushCursor.style.width = visualSize + 'px'; brushCursor.style.height = visualSize + 'px';
        }

        function setMaskAction(action) {
            maskAction = action;
            document.getElementById('m-action-reveal').className = action === 'reveal' ? 'px-2 py-1 bg-rose-500 text-white text-[9px] font-bold rounded transition-all' : 'px-2 py-1 bg-slate-700 text-white text-[9px] font-bold rounded transition-all';
            document.getElementById('m-action-hide').className = action === 'hide' ? 'px-2 py-1 bg-rose-500 text-white text-[9px] font-bold rounded transition-all' : 'px-2 py-1 bg-slate-700 text-white text-[9px] font-bold rounded transition-all';
        }

        function resetMask() {
            const layer = layers.find(l => l.id === activeLayerId);
            if (layer && layer.maskCanvas) {
                const mCtx = layer.maskCanvas.getContext('2d');
                mCtx.fillStyle = 'white'; mCtx.fillRect(0, 0, layer.maskCanvas.width, layer.maskCanvas.height);
                render(); showToast("Máscara restaurada");
            }
        }

        function paintOnMask(localX, localY, isFirst) {
            const layer = layers.find(l => l.id === activeLayerId);
            if (!layer) return;
            const mCtx = layer.maskCanvas.getContext('2d');
            const imgX = (localX / layer.width) * layer.maskCanvas.width, imgY = (localY / layer.height) * layer.maskCanvas.height;
            const realBrushSize = (maskBrushSize / layer.width) * layer.maskCanvas.width;
            mCtx.save(); mCtx.lineCap = 'round'; mCtx.lineJoin = 'round'; mCtx.lineWidth = realBrushSize;
            mCtx.globalCompositeOperation = maskAction === 'reveal' ? 'source-over' : 'destination-out';
            mCtx.strokeStyle = 'white';
            if (isFirst) { mCtx.beginPath(); mCtx.arc(imgX, imgY, realBrushSize/2, 0, Math.PI * 2); mCtx.fill(); }
            else { mCtx.beginPath(); mCtx.moveTo(maskStartX, maskStartY); mCtx.lineTo(imgX, imgY); mCtx.stroke(); }
            mCtx.restore(); maskStartX = imgX; maskStartY = imgY;
        }

        function applyRectMask(x1, y1, x2, y2) {
            const layer = layers.find(l => l.id === activeLayerId);
            if (!layer) return;
            const mCtx = layer.maskCanvas.getContext('2d');
            const imgX1 = (x1 / layer.width) * layer.maskCanvas.width, imgY1 = (y1 / layer.height) * layer.maskCanvas.height, imgX2 = (x2 / layer.width) * layer.maskCanvas.width, imgY2 = (y2 / layer.height) * layer.maskCanvas.height;
            mCtx.save(); mCtx.globalCompositeOperation = maskAction === 'reveal' ? 'source-over' : 'destination-out';
            mCtx.fillStyle = 'white'; mCtx.fillRect(imgX1, imgY1, imgX2 - imgX1, imgY2 - imgY1);
            mCtx.restore(); render();
        }

        function drawMeasureLine(m, index, isExporting) {
            const { x1, y1, x2, y2, text } = m;
            const dist = Math.sqrt(Math.pow(x2 - x1, 2) + Math.pow(y2 - y1, 2));
            const angle = Math.atan2(y2 - y1, x2 - x1);
            ctx.save();
            ctx.strokeStyle = '#000000'; ctx.lineWidth = 1.5; ctx.lineCap = 'round';
            ctx.translate(x1, y1); ctx.rotate(angle);
            let gap = 0; if (text) { ctx.font = "29px Inter, sans-serif"; gap = ctx.measureText(text).width + 30; }
            if (text && dist > gap) {
                ctx.beginPath(); ctx.moveTo(0, 0); ctx.lineTo(dist/2 - gap/2, 0); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(dist/2 + gap/2, 0); ctx.lineTo(dist, 0); ctx.stroke();
            } else { ctx.beginPath(); ctx.moveTo(0, 0); ctx.lineTo(dist, 0); ctx.stroke(); }
            const bl = 15; ctx.beginPath(); ctx.moveTo(0,-bl); ctx.lineTo(0,bl); ctx.moveTo(dist,-bl); ctx.lineTo(dist,bl); ctx.stroke();
            if (text) { ctx.save(); ctx.translate(dist / 2, 0); if (angle > Math.PI / 2 || angle < -Math.PI / 2) ctx.rotate(Math.PI); ctx.fillStyle = '#000000'; ctx.textAlign = "center"; ctx.textBaseline = "middle"; ctx.fillText(text, 0, 0); ctx.restore(); }
            ctx.restore();
            if (index !== -1 && !isExporting) {
                const bx = x2, by = y2 - 30; m.deleteBtn = { x: bx, y: by }; ctx.save();
                const act = (draggingMeasureIdx === index || hoveredMeasureIdx === index);
                ctx.fillStyle = act ? '#ef4444' : '#475569';
                ctx.beginPath(); ctx.arc(bx, by, 14, 0, Math.PI * 2); ctx.fill();
                ctx.strokeStyle = '#fff'; ctx.lineWidth = 2; ctx.beginPath();
                ctx.moveTo(bx-5, by-5); ctx.lineTo(bx+5, by+5); ctx.moveTo(bx+5, by-5); ctx.lineTo(bx-5, by+5); ctx.stroke(); ctx.restore();
            }
        }

        function clearAllMeasures() { if(confirm("¿Borrar todas las medidas?")) { measures = []; render(); } }

        function render(exportFormat = null) {
            const isExporting = (exportFormat === 'png' || exportFormat === 'jpeg');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            if (exportFormat === 'jpeg') { ctx.fillStyle = '#ffffff'; ctx.fillRect(0, 0, canvas.width, canvas.height); }
            [...layers].reverse().forEach(l => {
                if (!l.visible) return;
                ctx.save();
                const centerX = l.x + l.width / 2, centerY = l.y + l.height / 2;
                ctx.translate(centerX, centerY); ctx.rotate(l.rotation);
                ctx.globalAlpha = l.opacity / 100; ctx.globalCompositeOperation = l.blend;
                maskBuffer.width = l.width; maskBuffer.height = l.height;
                mbfCtx.clearRect(0, 0, l.width, l.height); mbfCtx.drawImage(l.processedCanvas, 0, 0, l.width, l.height);
                mbfCtx.globalCompositeOperation = 'destination-in'; mbfCtx.drawImage(l.maskCanvas, 0, 0, l.width, l.height);
                ctx.drawImage(maskBuffer, -l.width / 2, -l.height / 2);
                if (l.id === activeLayerId && editorMode === 'move' && !maskMode && !isExporting) {
                    ctx.strokeStyle = '#f43f5e'; ctx.lineWidth = 2; ctx.strokeRect(-l.width / 2, -l.height / 2, l.width, l.height);
                    ctx.fillStyle = '#f43f5e'; ctx.fillRect(l.width / 2 - 8, l.height / 2 - 8, 16, 16);
                    ctx.beginPath(); ctx.moveTo(0, -l.height / 2); ctx.lineTo(0, -l.height / 2 - 30); ctx.stroke();
                    ctx.beginPath(); ctx.arc(0, -l.height / 2 - 35, 10, 0, Math.PI * 2); ctx.fill();
                }
                ctx.restore();
            });
            measures.forEach((m, i) => drawMeasureLine(m, i, isExporting));
            if (activeMeasure) drawMeasureLine(activeMeasure, -1, isExporting);
        }

        function getMousePos(e) {
            const rect = canvas.getBoundingClientRect();
            let clientX, clientY;
            if (e.touches && e.touches.length > 0) {
                clientX = e.touches[0].clientX; clientY = e.touches[0].clientY;
            } else { clientX = e.clientX; clientY = e.clientY; }
            return { x: (clientX - rect.left) * (CANVAS_WIDTH / rect.width), y: (clientY - rect.top) * (CANVAS_HEIGHT / rect.height) };
        }

        function setupEventListeners() {
            canvas.addEventListener('mousedown', e => {
                const pos = getMousePos(e);
                if (editorMode === 'measure') {
                    for (let i = measures.length - 1; i >= 0; i--) {
                        const m = measures[i]; if (m.deleteBtn) { const d = Math.sqrt(Math.pow(pos.x - m.deleteBtn.x, 2) + Math.pow(pos.y - m.deleteBtn.y, 2)); if (d <= 20) { draggingMeasureIdx = i; mDragOffset.x = pos.x; mDragOffset.y = pos.y; hasMovedDraggedMeasure = false; isMouseDown = true; return; } }
                    }
                    activeMeasure = { x1: pos.x, y1: pos.y, x2: pos.x, y2: pos.y, text: "" }; isMouseDown = true; return;
                }
                const currentActiveLayer = layers.find(l => l.id === activeLayerId);
                if (currentActiveLayer && !maskMode) {
                    const cx = currentActiveLayer.x + currentActiveLayer.width / 2, cy = currentActiveLayer.y + currentActiveLayer.height / 2, dx = pos.x - cx, dy = pos.y - cy;
                    const lx = dx * Math.cos(-currentActiveLayer.rotation) - dy * Math.sin(-currentActiveLayer.rotation), ly = dx * Math.sin(-currentActiveLayer.rotation) + dy * Math.cos(-currentActiveLayer.rotation);
                    if (Math.sqrt(Math.pow(lx, 2) + Math.pow(ly - (-currentActiveLayer.height/2 - 35), 2)) < 20) {
                        currentActiveLayer.isRotating = true; isMouseDown = true; return;
                    }
                    if (Math.abs(lx - currentActiveLayer.width/2) < 20 && Math.abs(ly - currentActiveLayer.height/2) < 20) {
                        currentActiveLayer.isResizing = true; isMouseDown = true; return;
                    }
                }
                if (editorMode === 'move' && !maskMode) {
                    for (let i = 0; i < layers.length; i++) {
                        const l = layers[i]; if (!l.visible) continue;
                        const cx = l.x + l.width / 2, cy = l.y + l.height / 2, dx = pos.x - cx, dy = pos.y - cy;
                        const lx = dx * Math.cos(-l.rotation) - dy * Math.sin(-l.rotation), ly = dx * Math.sin(-l.rotation) + dy * Math.cos(-l.rotation);
                        if (Math.abs(lx) <= l.width / 2 && Math.abs(ly) <= l.height / 2) {
                            setActiveLayer(l.id); l.isDragging = true; dragOffset.x = pos.x - l.x; dragOffset.y = pos.y - l.y; isMouseDown = true; render(); return;
                        }
                    }
                }
                if (maskMode && currentActiveLayer) {
                    isMouseDown = true; 
                    const cx = currentActiveLayer.x + currentActiveLayer.width / 2, cy = currentActiveLayer.y + currentActiveLayer.height / 2, dx = pos.x - cx, dy = pos.y - cy;
                    const lx = dx * Math.cos(-currentActiveLayer.rotation) - dy * Math.sin(-currentActiveLayer.rotation), ly = dx * Math.sin(-currentActiveLayer.rotation) + dy * Math.cos(-currentActiveLayer.rotation);
                    maskStartX = (lx + currentActiveLayer.width / 2); maskStartY = (ly + currentActiveLayer.height / 2);
                    if (maskMode === 'brush') paintOnMask(maskStartX, maskStartY, true);
                    else if (maskMode === 'rect') { maskWorldStartX = pos.x; maskWorldStartY = pos.y; selectionGuide.style.display = 'block'; updateSelectionGuide(pos.x, pos.y, pos.x, pos.y); }
                }
            });

            window.addEventListener('mousemove', e => {
                const pos = getMousePos(e); if (maskMode === 'brush') { brushCursor.style.left = e.clientX + 'px'; brushCursor.style.top = e.clientY + 'px'; }
                if (editorMode === 'measure') {
                    let fHover = -1;
                    for (let i = 0; i < measures.length; i++) { const m = measures[i]; if (m.deleteBtn) { const d = Math.sqrt(Math.pow(pos.x - m.deleteBtn.x, 2) + Math.pow(pos.y - m.deleteBtn.y, 2)); if (d <= 20) { fHover = i; break; } } }
                    if (hoveredMeasureIdx !== fHover) { hoveredMeasureIdx = fHover; render(); }
                }
                if (!isMouseDown) return;
                const activeLayer = layers.find(l => l.id === activeLayerId);
                if (editorMode === 'measure') {
                    if (draggingMeasureIdx !== -1) { 
                        const dx = pos.x - mDragOffset.x, dy = pos.y - mDragOffset.y; 
                        if (Math.abs(dx) > 2 || Math.abs(dy) > 2) hasMovedDraggedMeasure = true; 
                        const m = measures[draggingMeasureIdx]; m.x1 += dx; m.x2 += dx; m.y1 += dy; m.y2 += dy; mDragOffset.x = pos.x; mDragOffset.y = pos.y; 
                    } else if (activeMeasure) {
                        if (shiftPressed) { const dx = pos.x-activeMeasure.x1, dy = pos.y-activeMeasure.y1, d = Math.sqrt(dx*dx+dy*dy), a = Math.round(Math.atan2(dy,dx)/(Math.PI/4))*(Math.PI/4); activeMeasure.x2 = activeMeasure.x1+Math.cos(a)*d; activeMeasure.y2 = activeMeasure.y1+Math.sin(a)*d; }
                        else { activeMeasure.x2 = pos.x; activeMeasure.y2 = pos.y; }
                    }
                    render(); return;
                }
                if (!activeLayer) return;
                if (maskMode) {
                    const cx = activeLayer.x + activeLayer.width / 2, cy = activeLayer.y + activeLayer.height / 2, dx = pos.x - cx, dy = pos.y - cy, lx = dx * Math.cos(-activeLayer.rotation) - dy * Math.sin(-activeLayer.rotation) + activeLayer.width/2, ly = dx * Math.sin(-activeLayer.rotation) + dy * Math.cos(-activeLayer.rotation) + activeLayer.height/2;
                    if (maskMode === 'brush') { paintOnMask(lx, ly, false); render(); }
                    else if (maskMode === 'rect') updateSelectionGuide(maskWorldStartX, maskWorldStartY, pos.x, pos.y);
                    return;
                }
                if (activeLayer.isRotating) { const cx = activeLayer.x + activeLayer.width / 2, cy = activeLayer.y + activeLayer.height / 2; let angle = Math.atan2(pos.y - cy, pos.x - cx) + Math.PI / 2; if (shiftPressed) angle = (Math.round((angle * 180 / Math.PI) / 45) * 45) * Math.PI / 180; activeLayer.rotation = angle; }
                else if (activeLayer.isResizing) { const cx = activeLayer.x + activeLayer.width / 2, cy = activeLayer.y + activeLayer.height / 2, dx = pos.x - cx, dy = pos.y - cy, lx = Math.max(10, dx * Math.cos(-activeLayer.rotation) - dy * Math.sin(-activeLayer.rotation)); let nw = lx * 2; activeLayer.width = nw; activeLayer.height = nw / activeLayer.aspectRatio; activeLayer.x = cx - nw / 2; activeLayer.y = cy - activeLayer.height / 2; syncScaleUI(activeLayer); }
                else if (activeLayer.isDragging) { activeLayer.x = pos.x - dragOffset.x; activeLayer.y = pos.y - dragOffset.y; }
                render();
            });

            window.addEventListener('mouseup', e => {
                if (editorMode === 'measure' && isMouseDown) { if (draggingMeasureIdx !== -1) { if (!hasMovedDraggedMeasure) measures.splice(draggingMeasureIdx, 1); draggingMeasureIdx = -1; } else if (activeMeasure) { const d = Math.sqrt(Math.pow(activeMeasure.x2-activeMeasure.x1,2)+Math.pow(activeMeasure.y2-activeMeasure.y1,2)); if (d > 10) { pendingMeasure = {...activeMeasure}; MODAL.el.classList.remove('hidden'); MODAL.input.value = ""; setTimeout(()=>MODAL.input.focus(),50); } activeMeasure = null; } }
                if (maskMode === 'rect' && isMouseDown) {
                    const pos = getMousePos(e), activeLayer = layers.find(l => l.id === activeLayerId), cx = activeLayer.x+activeLayer.width/2, cy = activeLayer.y+activeLayer.height/2;
                    const sdx = maskWorldStartX-cx, sdy = maskWorldStartY-cy, slx = sdx*Math.cos(-activeLayer.rotation)-sdy*Math.sin(-activeLayer.rotation)+activeLayer.width/2, sly = sdx*Math.sin(-activeLayer.rotation)+sdy*Math.cos(-activeLayer.rotation)+activeLayer.height/2;
                    const edx = pos.x-cx, edy = pos.y-cy, elx = edx*Math.cos(-activeLayer.rotation)-edy*Math.sin(-activeLayer.rotation)+activeLayer.width/2, ely = edx*Math.sin(-activeLayer.rotation)+edy*Math.cos(-activeLayer.rotation)+activeLayer.height/2;
                    applyRectMask(slx, sly, elx, ely);
                }
                isMouseDown = false; selectionGuide.style.display = 'none';
                layers.forEach(l => { l.isDragging = l.isResizing = l.isRotating = false; });
                render();
            });

            document.getElementById('input-lv-black').oninput = (e) => { const l = layers.find(l => l.id === activeLayerId); if(l) { l.levels.black = parseInt(e.target.value); document.getElementById('val-lv-black').textContent = e.target.value; applyEffects(l); render(); } };
            document.getElementById('input-lv-mid').oninput = (e) => { const l = layers.find(l => l.id === activeLayerId); if(l) { l.levels.gamma = parseFloat(e.target.value); document.getElementById('val-lv-mid').textContent = e.target.value; applyEffects(l); render(); } };
            document.getElementById('input-lv-white').oninput = (e) => { const l = layers.find(l => l.id === activeLayerId); if(l) { l.levels.white = parseInt(e.target.value); document.getElementById('val-lv-white').textContent = e.target.value; applyEffects(l); render(); } };
            document.getElementById('input-hue').oninput = (e) => { const l = layers.find(l => l.id === activeLayerId); if(l) { l.hsl.hue = parseInt(e.target.value); document.getElementById('val-hue').textContent = e.target.value + '°'; applyEffects(l); render(); } };
            document.getElementById('input-sat').oninput = (e) => { const l = layers.find(l => l.id === activeLayerId); if(l) { l.hsl.saturation = parseInt(e.target.value)/100; document.getElementById('val-sat').textContent = e.target.value + '%'; applyEffects(l); render(); } };
            MODAL.save.onclick = () => { if(pendingMeasure) { pendingMeasure.text = MODAL.input.value; measures.push(pendingMeasure); pendingMeasure = null; } MODAL.el.classList.add('hidden'); render(); };
            MODAL.cancel.onclick = () => { pendingMeasure = null; MODAL.el.classList.add('hidden'); render(); };
            document.getElementById('input-brush-size').oninput = (e) => { maskBrushSize = e.target.value; document.getElementById('val-brush-size').textContent = e.target.value + 'px'; if(maskMode === 'brush') updateBrushCursorVisual(); };
            document.getElementById('prop-opacity').oninput = (e) => { const l = layers.find(l => l.id === activeLayerId); if(l) { l.opacity = e.target.value; document.getElementById('opacity-val').textContent = l.opacity + '%'; render(); } };
            document.getElementById('prop-scale').oninput = (e) => { const l = layers.find(l => l.id === activeLayerId); if(l) { const cx = l.x + l.width/2, cy = l.y + l.height/2, nw = 1000 * (e.target.value/100); l.width = nw; l.height = nw / l.aspectRatio; l.x = cx - nw/2; l.y = cy - l.height/2; document.getElementById('scale-val').textContent = e.target.value + '%'; render(); } };
            document.getElementById('prop-blend').onchange = (e) => { const l = layers.find(l => l.id === activeLayerId); if(l) { l.blend = e.target.value; render(); } };
            
            // Actualización para carga múltiple desde el input de archivo
            fileInput.onchange = (e) => { 
                const files = Array.from(e.target.files);
                const imageFiles = files.filter(f => f.type.startsWith('image/'));
                
                if (imageFiles.length > 0) {
                    showToast(`Cargando ${imageFiles.length} imágenes...`);
                    imageFiles.forEach(file => {
                        const reader = new FileReader();
                        reader.onload = (ev) => addLayer(ev.target.result, file.name);
                        reader.readAsDataURL(file);
                    });
                }
                fileInput.value = ""; 
            };
        }

        function syncScaleUI(layer) { const s = Math.round((layer.width/1000)*100); document.getElementById('prop-scale').value = s; document.getElementById('scale-val').textContent = s + '%'; }
        function updateSelectionGuide(x1, y1, x2, y2) { const r = canvas.getBoundingClientRect(), s = r.width/CANVAS_WIDTH; selectionGuide.style.left = (Math.min(x1,x2)*s)+canvas.offsetLeft+'px'; selectionGuide.style.top = (Math.min(y1,y2)*s)+canvas.offsetTop+'px'; selectionGuide.style.width = Math.abs(x1-x2)*s+'px'; selectionGuide.style.height = Math.abs(y1-y2)*s+'px'; }

        function updateUI() {
            layerListEl.innerHTML = '';
            layers.forEach((l, index) => {
                const isActive = activeLayerId === l.id;
                const div = document.createElement('div');
                div.className = `layer-item flex items-center gap-3 p-3 rounded-xl cursor-pointer transition-all hover:bg-slate-800/30 ${isActive ? 'active' : ''}`;
                div.onclick = () => { if(editorMode !== 'measure') setActiveLayer(l.id); };
                div.innerHTML = `
                    <div class="thumb-container w-10 h-10 bg-slate-800 rounded overflow-hidden border border-slate-700 flex-shrink-0">
                        <img src="${l.content.src}" class="w-full h-full object-contain ${l.visible ? '' : 'opacity-20 grayscale'}">
                    </div>
                    <span class="text-[11px] font-medium flex-1 truncate ${!l.visible ? 'text-slate-600' : 'text-slate-200'}">${l.name}</span>
                    <button onclick="event.stopPropagation(); toggleVisibility('${l.id}')" class="p-2 ${l.visible ? 'text-rose-500' : 'text-slate-600'} hover:text-white">
                        <svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px" fill="currentColor"><path d="M480-320q75 0 127.5-52.5T660-500q0-75-52.5-127.5T480-680q-75 0-127.5 52.5T300-500q0 75 52.5 127.5T480-320Zm0-72q-45 0-76.5-31.5T372-500q0-45 31.5-76.5T480-608q45 0 76.5 31.5T588-500q0 45-31.5 76.5T480-392Zm0 192q-146 0-266-81.5T40-500q54-137 174-218.5T480-800q146 0 266 81.5T920-500q-54 137-174 218.5T480-200Zm0-72q113 0 207.5-59.5T832-500q-50-101-144.5-160.5T480-720q-113 0-207.5 59.5T128-500q50 101 144.5 160.5T480-280q113 0 207.5-59.5Z"/></svg>
                    </button>
                `;
                layerListEl.appendChild(div);
            });
            const propsEl = document.getElementById('layer-props');
            const noLayerEl = document.getElementById('no-layer-msg');
            const activeLayer = layers.find(l => l.id === activeLayerId);
            if (activeLayer && editorMode !== 'measure') {
                propsEl.classList.remove('hidden'); noLayerEl.classList.add('hidden');
                document.getElementById('opacity-val').textContent = activeLayer.opacity + '%';
                document.getElementById('prop-opacity').value = activeLayer.opacity;
                document.getElementById('prop-blend').value = activeLayer.blend;
                syncScaleUI(activeLayer);
                document.getElementById('input-lv-black').value = activeLayer.levels.black;
                document.getElementById('val-lv-black').textContent = activeLayer.levels.black;
                document.getElementById('input-lv-mid').value = activeLayer.levels.gamma;
                document.getElementById('val-lv-mid').textContent = activeLayer.levels.gamma;
                document.getElementById('input-lv-white').value = activeLayer.levels.white;
                document.getElementById('val-lv-white').textContent = activeLayer.levels.white;
                document.getElementById('input-hue').value = activeLayer.hsl.hue;
                document.getElementById('val-hue').textContent = activeLayer.hsl.hue + '°';
                document.getElementById('input-sat').value = Math.round(activeLayer.hsl.saturation * 100);
                document.getElementById('val-sat').textContent = Math.round(activeLayer.hsl.saturation * 100) + '%';
            } else { propsEl.classList.add('hidden'); noLayerEl.classList.remove('hidden'); }
        }

        function toggleVisibility(id) { const l = layers.find(lay => lay.id === id); if (l) { l.visible = !l.visible; render(); updateUI(); } }
        function deleteActiveLayer() { layers = layers.filter(l => l.id !== activeLayerId); activeLayerId = null; render(); updateUI(); }
        function showToast(msg) { const t = document.getElementById('toast'); t.textContent = msg; t.classList.add('opacity-100'); setTimeout(() => t.classList.remove('opacity-100'), 2000); }

        function fitActiveLayerToCanvas() {
            const l = layers.find(lay => lay.id === activeLayerId);
            if (l) {
                if (l.aspectRatio > 1) { l.height = 1000; l.width = 1000 * l.aspectRatio; } else { l.width = 1000; l.height = 1000 / l.aspectRatio; }
                l.x = (1000 - l.width)/2; l.y = (1000 - l.height)/2; l.rotation = 0; syncScaleUI(l); render();
            }
        }

        function exportImage(format = 'png') {
            const oldId = activeLayerId, oldMaskMode = maskMode; activeLayerId = null; maskMode = false;
            render(format);
            setTimeout(() => {
                const link = document.createElement('a');
                link.download = `arelyshop-photo-${Date.now()}.${format}`;
                link.href = canvas.toDataURL(format === 'jpeg' ? 'image/jpeg' : 'image/png', 0.92);
                link.click(); showToast(`Exportado como ${format.toUpperCase()}`);
                activeLayerId = oldId; maskMode = oldMaskMode; render(); updateUI();
            }, 100);
        }

        init();
    </script>
</body>
</html>
